<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EventHub - Area Admin</title>
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/admin.css">
</head>
<body>

<div id="notificationContainer"></div>

<header>
  <h1>EventHub - Area Admin</h1>
  <div>
    <button id="notificationsBtn" onclick="toggleNotifications()">
      <span id="notificationBadge" class="badge" style="display:none;">0</span>
      Notifiche
    </button>
    <button id="logoutBtn">Logout</button>
    <button onclick="window.location.href='/register-admin.html'">Registra nuovo Admin</button>
  </div>
</header>

<!-- Pannello Notifiche -->
<div id="notificationsPanel" style="display:none;">
  <div class="box">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>Notifiche</h3>
      <div>
        <button onclick="markAllNotificationsAsRead()" class="secondary">Segna tutte come lette</button>
        <button onclick="deleteReadNotifications()" class="danger">Elimina lette</button>
        <button onclick="toggleNotifications()" class="secondary">‚úñ Chiudi</button>
      </div>
    </div>
    <div id="notificationsList"></div>
  </div>
</div>

<!-- Statistiche -->
<div class="stats-container">
  <div class="stat-card">
    <h3>Eventi Totali</h3>
    <p class="stat-number" id="totalEventsCount">0</p>
  </div>
  <div class="stat-card secondary">
    <h3>Eventi in Attesa</h3>
    <p class="stat-number" id="pendingEventsCount">0</p>
  </div>
  <div class="stat-card accent">
    <h3>Utenti Registrati</h3>
    <p class="stat-number" id="totalUsersCount">0</p>
  </div>
</div>

<div class="dashboard">
  <div class="box">
    <h3>Eventi in attesa</h3>
    <div id="pendingEvents"></div>
  </div>

  <div class="box">
    <h3>Tutti gli eventi</h3>
    <div id="allEvents"></div>
  </div>

  <div class="box">
    <h3>Eventi pubblici</h3>
    <div id="publicEvents"></div>
  </div>

  <div class="box">
    <h3>Utenti</h3>
    <div id="allUsers"></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const token = localStorage.getItem('token');
if (!token) window.location.href = '/login.html';

// Verifica che sia un admin
const payload = JSON.parse(atob(token.split('.')[1]));
if (payload.role !== 'admin') {
  window.location.href = '/user.html';
}

// Inizializzazione Socket.IO
const socket = io({ 
  auth: { token },
  transports: ['websocket'],
  timeout: 5000
});

socket.on('connect', () => {
  console.log('Socket admin connesso:', socket.id);
});

socket.on('connect_error', (err) => {
  console.error('Errore connessione socket:', err.message);
});

// Notifiche per eventi segnalati
socket.on('event-reported', (payload) => {
  console.log('Evento segnalato ricevuto:', payload); // Debug: Evento ricevuto
  showNotification(`Segnalazione: "${payload.event?.title || 'Evento #' + payload.event?.id}" da ${payload.reporter?.name || 'Utente'}`);
  // Ricarica la lista eventi per mostrare eventuali aggiornamenti
  loadAllEvents();
});

// Nuova notifica admin persistente
socket.on('new-admin-notification', (notification) => {
  console.log('Nuova notifica admin:', notification);
  showNotification(notification.message);
  loadNotifications(); // Ricarica la lista notifiche
  updateNotificationBadge(); // Aggiorna il badge
});

// Funzioni per le notifiche
function showNotification(text, timeout = 4000) {
  console.log('showNotification chiamata con:', text); // Debug: Funzione chiamata
  const container = document.getElementById('notificationContainer');

  const el = document.createElement('div');
  el.className = 'toast-notification';
  el.textContent = text;
  container.appendChild(el);

  setTimeout(() => {
    el.classList.add('hide');
    el.addEventListener('transitionend', () => el.remove(), { once: true });
  }, timeout);
}

// Funzione per fare fetch con auth
async function fetchAuth(url, options = {}) {
  options.headers = { ...options.headers, Authorization: `Bearer ${token}` };
  const res = await fetch(url, options);
  return res.json();
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('token');
  window.location.href = '/login.html';
});

// Carica eventi in attesa
async function loadPendingEvents() {
  const container = document.getElementById('pendingEvents');
  const events = await fetchAuth('/api/admin/events/pending');
  
  // Aggiorna contatore
  document.getElementById('pendingEventsCount').textContent = events.length;
  
  container.innerHTML = '';
  if (events.length === 0) {
    container.innerHTML = '<p>Nessun evento in attesa di approvazione</p>';
    return;
  }
  
  events.forEach(ev => {
    const eventDate = new Date(ev.date);
    const div = document.createElement('div');
    div.className = 'admin-event-card';
    div.innerHTML = `
      <img src="${ev.image || '/assets/images/defaults/event-default.jpg'}" alt="${ev.title}">
      <div class="event-info">
        <h4 class="event-title">${ev.title}</h4>
        <div class="event-meta">
          <span>üìÅ ${ev.category || 'Generale'}</span> ‚Ä¢ 
          <span>üìç ${ev.location}</span>
        </div>
        <div class="event-meta">
          <span>üìÖ ${eventDate.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
        </div>
        <div class="event-meta">
          <span>üë• Capacit√†: ${ev.capacity} persone</span>
        </div>
        <div class="event-actions">
          <button onclick="approveEvent(${ev.id})" class="primary">‚úì Approva</button>
          <button onclick="rejectEvent(${ev.id})" class="danger">‚úó Rifiuta</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

// Approvare / rifiutare eventi
async function approveEvent(id) {
  await fetchAuth(`/api/admin/events/${id}/approve`, { method: 'PUT' });
  loadPendingEvents();
  loadAllEvents();
  updateStats();
}
async function rejectEvent(id) {
  await fetchAuth(`/api/admin/events/${id}/reject`, { method: 'PUT' });
  loadPendingEvents();
  loadAllEvents();
  updateStats();
}

// Carica tutti gli eventi (modifica / elimina)
async function loadAllEvents() {
  const container = document.getElementById('allEvents');
  const events = await fetchAuth('/api/admin/events/all');
  
  // Aggiorna contatore
  document.getElementById('totalEventsCount').textContent = events.length;
  
  container.innerHTML = '';
  if (events.length === 0) {
    container.innerHTML = '<p>Nessun evento presente</p>';
    return;
  }
  
  events.forEach(ev => {
    const eventDate = new Date(ev.date);
    const div = document.createElement('div');
    div.className = 'admin-event-card';
    div.innerHTML = `
      <img src="${ev.image || '/assets/images/defaults/event-default.jpg'}" alt="${ev.title}">
      <div class="event-info">
        <h4 class="event-title">${ev.title}</h4>
        <div class="event-meta">
          <span>Categoria: ${ev.category || 'Generale'}</span> 
          <span>Luogo: ${ev.location}</span>
        </div>
        <div class="event-meta">
          <span>Data: ${eventDate.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
        </div>
        <div class="event-meta">
          <span>Capacit√†: ${ev.capacity} persone</span>
        </div>
        <div class="event-actions">
          <button onclick="window.location.href='/edit-event.html?id=${ev.id}'" class="secondary">Modifica</button>
          <button onclick="deleteEvent(${ev.id})" class="danger">Elimina</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

async function deleteEvent(id) {
  if (!confirm('Sei sicuro di voler eliminare questo evento?')) return;
  await fetchAuth(`/api/events/${id}`, { method: 'DELETE' });
  loadAllEvents();
  loadPendingEvents();
  updateStats();
}

// Carica eventi pubblici (come utenti)
async function loadPublicEvents() {
  const container = document.getElementById('publicEvents');
  const events = await fetch('/api/events').then(r => r.json());
  container.innerHTML = '';
  events.forEach(ev => {
    const div = document.createElement('div');
    div.className = 'event-box';
    div.innerHTML = `
      <strong>${ev.title}</strong><br>${ev.category} - ${ev.location} - ${new Date(ev.date).toLocaleDateString()}`;
    container.appendChild(div);
  });
}

// Carica utenti
async function loadUsers() {
  const container = document.getElementById('allUsers');
  const users = await fetchAuth('/api/admin/users');
  
  // Aggiorna contatore
  document.getElementById('totalUsersCount').textContent = users.length;
  
  container.innerHTML = '';
  if (users.length === 0) {
    container.innerHTML = '<p>Nessun utente registrato</p>';
    return;
  }
  
  users.forEach(u => {
    const div = document.createElement('div');
    div.className = 'event-box';
    div.innerHTML = `
      <strong>${u.name}</strong> <span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">${u.role}</span><br>
      ${u.email}<br>
      Stato: ${u.isActive ? '<span style="color: green;">‚úì Attivo</span>' : '<span style="color: red;">‚úó Bloccato</span>'}<br>
      <div style="margin-top: 10px; display: flex; gap: 8px;">
        <button onclick="blockUser(${u.id})" class="danger" ${!u.isActive ? 'disabled' : ''}>Blocca</button>
        <button onclick="unblockUser(${u.id})" class="secondary" ${u.isActive ? 'disabled' : ''}>Sblocca</button>
      </div>
    `;
    container.appendChild(div);
  });
}

async function blockUser(id) { 
  await fetchAuth(`/api/admin/users/${id}/block`, { method: 'PUT' }); 
  loadUsers(); 
}
async function unblockUser(id) { 
  await fetchAuth(`/api/admin/users/${id}/unblock`, { method: 'PUT' }); 
  loadUsers(); 
}

// Aggiorna tutte le statistiche
async function updateStats() {
  try {
    const [allEvents, pendingEvents, users] = await Promise.all([
      fetchAuth('/api/admin/events/all'),
      fetchAuth('/api/admin/events/pending'),
      fetchAuth('/api/admin/users')
    ]);
    
    document.getElementById('totalEventsCount').textContent = allEvents.length;
    document.getElementById('pendingEventsCount').textContent = pendingEvents.length;
    document.getElementById('totalUsersCount').textContent = users.length;
  } catch (error) {
    console.error('Errore aggiornamento statistiche:', error);
  }
}

// ===== GESTIONE NOTIFICHE =====

// Toggle pannello notifiche
function toggleNotifications() {
  const panel = document.getElementById('notificationsPanel');
  const dashboard = document.querySelector('.dashboard');
  
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    dashboard.style.display = 'none';
    loadNotifications();
  } else {
    panel.style.display = 'none';
    dashboard.style.display = 'grid';
  }
}

// Carica le notifiche
async function loadNotifications() {
  try {
    const data = await fetchAuth('/api/notifications?limit=100');
    const container = document.getElementById('notificationsList');
    
    if (data.notifications.length === 0) {
      container.innerHTML = '<p>Nessuna notifica</p>';
      return;
    }
    
    container.innerHTML = data.notifications.map(notif => {
      const date = new Date(notif.createdAt).toLocaleString('it-IT');
      const readClass = notif.isRead ? 'notification-read' : 'notification-unread';
      
      return `
        <div class="event-box ${readClass}" style="opacity: ${notif.isRead ? '0.6' : '1'}">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <strong>${notif.title}</strong>
              <p>${notif.message}</p>
              <small style="color: #666;">${date}</small>
            </div>
            <div style="display: flex; gap: 5px;">
              ${!notif.isRead ? `<button onclick="markNotificationAsRead(${notif.id})" class="secondary" style="padding: 5px 10px;">‚úì</button>` : ''}
              <button onclick="deleteNotificationById(${notif.id})" class="danger" style="padding: 5px 10px;">‚úñ</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    updateNotificationBadge();
  } catch (error) {
    console.error('Errore caricamento notifiche:', error);
  }
}

// Aggiorna il badge con il numero di notifiche non lette
async function updateNotificationBadge() {
  try {
    const data = await fetchAuth('/api/notifications?limit=1');
    const badge = document.getElementById('notificationBadge');
    
    if (data.unreadCount > 0) {
      badge.textContent = data.unreadCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  } catch (error) {
    console.error('Errore aggiornamento badge:', error);
  }
}

// Segna una notifica come letta
async function markNotificationAsRead(id) {
  try {
    await fetchAuth(`/api/notifications/${id}/read`, { method: 'PUT' });
    loadNotifications();
  } catch (error) {
    console.error('Errore:', error);
  }
}

// Segna tutte le notifiche come lette
async function markAllNotificationsAsRead() {
  try {
    await fetchAuth('/api/notifications/read-all', { method: 'PUT' });
    loadNotifications();
  } catch (error) {
    console.error('Errore:', error);
  }
}

// Elimina una notifica
async function deleteNotificationById(id) {
  if (!confirm('Vuoi eliminare questa notifica?')) return;
  
  try {
    await fetchAuth(`/api/notifications/${id}`, { method: 'DELETE' });
    loadNotifications();
  } catch (error) {
    console.error('Errore:', error);
  }
}

// Elimina tutte le notifiche lette
async function deleteReadNotifications() {
  if (!confirm('Vuoi eliminare tutte le notifiche lette?')) return;
  
  try {
    await fetchAuth('/api/notifications/read/all', { method: 'DELETE' });
    loadNotifications();
  } catch (error) {
    console.error('Errore:', error);
  }
}

// Carica tutto all'avvio
loadPendingEvents();
loadAllEvents();
loadPublicEvents();
loadUsers();
updateNotificationBadge(); // Aggiorna il badge delle notifiche
</script>
</body>
</html>
