<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EventHub - Area Admin</title>
<link rel="stylesheet" href="/css/style.css">
<style>
  #notificationContainer {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }
  .toast-notification {
    background: #333;
    color: white;
    padding: 8px 12px;
    margin-top: 8px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    min-width: 200px;
    opacity: 1;
    transition: opacity 0.3s ease-in-out;
  }
  .toast-notification.hide {
    opacity: 0;
  }
  
  #notificationsBtn {
    position: relative;
  }
  
  #notificationBadge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #E53E3E;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.75rem;
    font-weight: bold;
    min-width: 20px;
    text-align: center;
  }
  
  .notification-unread {
    border-left: 4px solid var(--primary);
  }
  
  .notification-read {
    border-left: 4px solid #ccc;
  }
</style>
</head>
<body>

<div id="notificationContainer"></div>

<header>
  <h1>EventHub - Area Admin</h1>
  <div>
    <button id="notificationsBtn" onclick="toggleNotifications()">
      <span id="notificationBadge" class="badge" style="display:none;">0</span>
      ðŸ”” Notifiche
    </button>
    <button id="logoutBtn">Logout</button>
    <button onclick="window.location.href='/register-admin.html'">Registra nuovo Admin</button>
  </div>
</header>

<!-- Pannello Notifiche -->
<div id="notificationsPanel" style="display:none;">
  <div class="box">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>Notifiche</h3>
      <div>
        <button onclick="markAllNotificationsAsRead()" class="secondary">Segna tutte come lette</button>
        <button onclick="deleteReadNotifications()" class="danger">Elimina lette</button>
        <button onclick="toggleNotifications()" class="secondary">âœ– Chiudi</button>
      </div>
    </div>
    <div id="notificationsList"></div>
  </div>
</div>

<div class="dashboard">
  <div class="box">
    <h3>Eventi in attesa</h3>
    <div id="pendingEvents"></div>
  </div>

  <div class="box">
    <h3>Tutti gli eventi</h3>
    <div id="allEvents"></div>
  </div>

  <div class="box">
    <h3>Eventi pubblici</h3>
    <div id="publicEvents"></div>
  </div>

  <div class="box">
    <h3>Utenti</h3>
    <div id="allUsers"></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const token = localStorage.getItem('token');
if (!token) window.location.href = '/login.html';

// Verifica che sia un admin
const payload = JSON.parse(atob(token.split('.')[1]));
if (payload.role !== 'admin') {
  window.location.href = '/user.html';
}

// Inizializzazione Socket.IO
const socket = io({ 
  auth: { token },
  transports: ['websocket'],
  timeout: 5000
});

socket.on('connect', () => {
  console.log('Socket admin connesso:', socket.id);
});

socket.on('connect_error', (err) => {
  console.error('Errore connessione socket:', err.message);
});

// Notifiche per eventi segnalati
socket.on('event-reported', (payload) => {
  console.log('Evento segnalato ricevuto:', payload); // Debug: Evento ricevuto
  showNotification(`Segnalazione: "${payload.event?.title || 'Evento #' + payload.event?.id}" da ${payload.reporter?.name || 'Utente'}`);
  // Ricarica la lista eventi per mostrare eventuali aggiornamenti
  loadAllEvents();
});

// Nuova notifica admin persistente
socket.on('new-admin-notification', (notification) => {
  console.log('Nuova notifica admin:', notification);
  showNotification(notification.message);
  loadNotifications(); // Ricarica la lista notifiche
  updateNotificationBadge(); // Aggiorna il badge
});

// Funzioni per le notifiche
function showNotification(text, timeout = 4000) {
  console.log('showNotification chiamata con:', text); // Debug: Funzione chiamata
  const container = document.getElementById('notificationContainer');

  const el = document.createElement('div');
  el.className = 'toast-notification';
  el.textContent = text;
  container.appendChild(el);

  setTimeout(() => {
    el.classList.add('hide');
    el.addEventListener('transitionend', () => el.remove(), { once: true });
  }, timeout);
}

// Funzione per fare fetch con auth
async function fetchAuth(url, options = {}) {
  options.headers = { ...options.headers, Authorization: `Bearer ${token}` };
  const res = await fetch(url, options);
  return res.json();
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('token');
  window.location.href = '/login.html';
});

// Carica eventi in attesa
async function loadPendingEvents() {
  const container = document.getElementById('pendingEvents');
  const events = await fetchAuth('/api/admin/events/pending');
  container.innerHTML = '';
  events.forEach(ev => {
    const div = document.createElement('div');
    div.className = 'event-box';
    div.innerHTML = `
      <strong>${ev.title}</strong><br>
      ${ev.category} - ${ev.location} - ${new Date(ev.date).toLocaleDateString()}<br>
      <button onclick="approveEvent(${ev.id})">Approva</button>
      <button onclick="rejectEvent(${ev.id})">Rifiuta</button>
    `;
    container.appendChild(div);
  });
}

// Approvare / rifiutare eventi
async function approveEvent(id) {
  await fetchAuth(`/api/admin/events/${id}/approve`, { method: 'PUT' });
  loadPendingEvents();
  loadAllEvents();
}
async function rejectEvent(id) {
  await fetchAuth(`/api/admin/events/${id}/reject`, { method: 'PUT' });
  loadPendingEvents();
  loadAllEvents();
}

// Carica tutti gli eventi (modifica / elimina)
async function loadAllEvents() {
  const container = document.getElementById('allEvents');
  const events = await fetchAuth('/api/admin/events/all');
  container.innerHTML = '';
  events.forEach(ev => {
    const div = document.createElement('div');
    div.className = 'event-box';
    div.innerHTML = `
      <strong>${ev.title}</strong><br>
      ${ev.category} - ${ev.location} - ${new Date(ev.date).toLocaleDateString()}<br>
      <button onclick="window.location.href='/edit-event.html?id=${ev.id}'">Modifica</button>
      <button onclick="deleteEvent(${ev.id})">Elimina</button>
    `;
    container.appendChild(div);
  });
}

async function deleteEvent(id) {
  await fetchAuth(`/api/events/${id}`, { method: 'DELETE' });
  loadAllEvents();
  loadPendingEvents();
}

// Carica eventi pubblici (come utenti)
async function loadPublicEvents() {
  const container = document.getElementById('publicEvents');
  const events = await fetch('/api/events').then(r => r.json());
  container.innerHTML = '';
  events.forEach(ev => {
    const div = document.createElement('div');
    div.className = 'event-box';
    div.innerHTML = `
      <strong>${ev.title}</strong><br>${ev.category} - ${ev.location} - ${new Date(ev.date).toLocaleDateString()}`;
    container.appendChild(div);
  });
}

// Carica utenti
async function loadUsers() {
  const container = document.getElementById('allUsers');
  const users = await fetchAuth('/api/admin/users');
  container.innerHTML = '';
  users.forEach(u => {
    const div = document.createElement('div');
    div.className = 'event-box';
    div.innerHTML = `
      <strong>${u.name}</strong> (${u.role})<br>${u.email}<br>
      Stato: ${u.isActive ? 'Attivo' : 'Bloccato'}<br>
      <button onclick="blockUser(${u.id})">Blocca</button>
      <button onclick="unblockUser(${u.id})">Sblocca</button>
    `;
    container.appendChild(div);
  });
}

async function blockUser(id) { await fetchAuth(`/api/admin/users/${id}/block`, { method: 'PUT' }); loadUsers(); }
async function unblockUser(id) { await fetchAuth(`/api/admin/users/${id}/unblock`, { method: 'PUT' }); loadUsers(); }

// ===== GESTIONE NOTIFICHE =====

// Toggle pannello notifiche
function toggleNotifications() {
  const panel = document.getElementById('notificationsPanel');
  const dashboard = document.querySelector('.dashboard');
  
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    dashboard.style.display = 'none';
    loadNotifications();
  } else {
    panel.style.display = 'none';
    dashboard.style.display = 'grid';
  }
}

// Carica le notifiche
async function loadNotifications() {
  try {
    const data = await fetchAuth('/api/notifications?limit=100');
    const container = document.getElementById('notificationsList');
    
    if (data.notifications.length === 0) {
      container.innerHTML = '<p>Nessuna notifica</p>';
      return;
    }
    
    container.innerHTML = data.notifications.map(notif => {
      const date = new Date(notif.createdAt).toLocaleString('it-IT');
      const readClass = notif.isRead ? 'notification-read' : 'notification-unread';
      
      return `
        <div class="event-box ${readClass}" style="opacity: ${notif.isRead ? '0.6' : '1'}">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <strong>${notif.title}</strong>
              <p>${notif.message}</p>
              <small style="color: #666;">${date}</small>
            </div>
            <div style="display: flex; gap: 5px;">
              ${!notif.isRead ? `<button onclick="markNotificationAsRead(${notif.id})" class="secondary" style="padding: 5px 10px;">âœ“</button>` : ''}
              <button onclick="deleteNotificationById(${notif.id})" class="danger" style="padding: 5px 10px;">âœ–</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    updateNotificationBadge();
  } catch (error) {
    console.error('Errore caricamento notifiche:', error);
  }
}

// Aggiorna il badge con il numero di notifiche non lette
async function updateNotificationBadge() {
  try {
    const data = await fetchAuth('/api/notifications?limit=1');
    const badge = document.getElementById('notificationBadge');
    
    if (data.unreadCount > 0) {
      badge.textContent = data.unreadCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  } catch (error) {
    console.error('Errore aggiornamento badge:', error);
  }
}

// Segna una notifica come letta
async function markNotificationAsRead(id) {
  try {
    await fetchAuth(`/api/notifications/${id}/read`, { method: 'PUT' });
    loadNotifications();
  } catch (error) {
    console.error('Errore:', error);
  }
}

// Segna tutte le notifiche come lette
async function markAllNotificationsAsRead() {
  try {
    await fetchAuth('/api/notifications/read-all', { method: 'PUT' });
    loadNotifications();
  } catch (error) {
    console.error('Errore:', error);
  }
}

// Elimina una notifica
async function deleteNotificationById(id) {
  if (!confirm('Vuoi eliminare questa notifica?')) return;
  
  try {
    await fetchAuth(`/api/notifications/${id}`, { method: 'DELETE' });
    loadNotifications();
  } catch (error) {
    console.error('Errore:', error);
  }
}

// Elimina tutte le notifiche lette
async function deleteReadNotifications() {
  if (!confirm('Vuoi eliminare tutte le notifiche lette?')) return;
  
  try {
    await fetchAuth('/api/notifications/read/all', { method: 'DELETE' });
    loadNotifications();
  } catch (error) {
    console.error('Errore:', error);
  }
}

// Carica tutto all'avvio
loadPendingEvents();
loadAllEvents();
loadPublicEvents();
loadUsers();
updateNotificationBadge(); // Aggiorna il badge delle notifiche
</script>
</body>
</html>
