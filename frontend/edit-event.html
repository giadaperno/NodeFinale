<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EventHub - Modifica Evento</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header>
  <h1><i class="fas fa-edit"></i> EventHub - Modifica Evento</h1>
  <button id="backBtn" class="secondary"><i class="fas fa-arrow-left"></i> Indietro</button>
</header>

<div class="auth-container">
  <h2><i class="fas fa-pen"></i> Modifica evento</h2>
  
  <div class="form-group">
    <label for="title"><i class="fas fa-heading"></i> Titolo evento *</label>
    <input type="text" id="title" placeholder="Es: Concerto Rock 2025">
  </div>

  <div class="form-group">
    <label for="description"><i class="fas fa-align-left"></i> Descrizione *</label>
    <textarea id="description" placeholder="Descrivi il tuo evento..." rows="5"></textarea>
  </div>

  <div class="form-group">
    <label for="category"><i class="fas fa-tag"></i> Categoria *</label>
    <select id="category">
      <option value="">Seleziona una categoria</option>
      <option value="Musica">Musica</option>
      <option value="Sport">Sport</option>
      <option value="Fiera">Fiera</option>
      <option value="Cucina">Cucina</option>
      <option value="Benessere">Benessere</option>
    </select>
  </div>

  <div class="form-group">
    <label for="location"><i class="fas fa-map-marker-alt"></i> Luogo *</label>
    <input type="text" id="location" placeholder="Es: Teatro Comunale, Milano">
  </div>

  <div class="form-group">
    <label for="date"><i class="fas fa-calendar"></i> Data *</label>
    <input type="date" id="date">
  </div>

  <div class="form-group">
    <label for="capacity"><i class="fas fa-users"></i> Capacità massima *</label>
    <input type="number" id="capacity" placeholder="Es: 100" min="1">
  </div>

  <div class="form-group">
    <label for="image"><i class="fas fa-image"></i> URL Immagine (opzionale)</label>
    <input type="url" id="image" placeholder="https://esempio.com/immagine.jpg" maxlength="2000">
    <small style="color: var(--text-light); display: block; margin-top: 5px;">
      <i class="fas fa-info-circle"></i> Incolla il link di un'immagine per rendere il tuo evento più unico
    </small>
  </div>
  
  <button id="updateBtn" class="primary">
    <i class="fas fa-save"></i> Salva Modifiche
  </button>

  <div id="message" style="margin-top:15px;"></div>
</div>

<script>
const token = localStorage.getItem('token');
if (!token) window.location.href = '/login.html';

const urlParams = new URLSearchParams(window.location.search);
const eventId = urlParams.get('id');

if (!eventId) {
  alert('Evento non trovato');
  window.location.href = '/user.html';
}

// Carica dati evento
async function loadEvent() {
  try {
    const res = await fetch(`/api/events/${eventId}`);
    const data = await res.json();
    if (!res.ok) {
      alert(data.message || 'Ops! Non riusciamo a trovare questo evento');
      window.location.href = '/user.html';
    } else {
      document.getElementById('title').value = data.title;
      document.getElementById('description').value = data.description;
      document.getElementById('category').value = data.category;
      document.getElementById('location').value = data.location;
      document.getElementById('date').value = data.date.split('T')[0];
      document.getElementById('capacity').value = data.capacity;
      document.getElementById('image').value = data.image || '';
    }
  } catch(err) {
    console.error(err);
    alert('Ops! Qualcosa è andato storto nel caricamento dell\'evento');
    window.location.href = '/user.html';
  }
}

loadEvent();

// Aggiorna evento
document.getElementById('updateBtn').addEventListener('click', async () => {
  const title = document.getElementById('title').value.trim();
  const description = document.getElementById('description').value.trim();
  const category = document.getElementById('category').value;
  const location = document.getElementById('location').value.trim();
  const date = document.getElementById('date').value;
  const capacity = document.getElementById('capacity').value;
  const image = document.getElementById('image').value.trim();

  const messageDiv = document.getElementById('message');
  messageDiv.textContent = '';
  messageDiv.className = '';

  const errors = [];

  // Client-side validation
  if (!title) {
    errors.push('Il titolo dell\'evento è obbligatorio.');
  }
  if (!description) {
    errors.push('La descrizione dell\'evento è obbligatoria.');
  }
  if (!category) {
    errors.push('Seleziona una categoria.');
  }
  if (!location) {
    errors.push('Il luogo è obbligatorio.');
  }
  if (!date) {
    errors.push('La data è obbligatoria.');
  }
  if (!capacity || isNaN(capacity) || parseInt(capacity) <= 0) {
    errors.push('Inserisci una capacità valida (numero positivo).');
  }

  if (errors.length > 0) {
    messageDiv.innerHTML = errors.join('<br>');
    return;
  }

  const updateBtn = document.getElementById('updateBtn');
  
  // Disabilita il pulsante durante l'invio
  updateBtn.disabled = true;
  updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';

  const event = {
    title,
    description,
    category,
    location,
    date,
    capacity: parseInt(capacity),
    image
  };

  try {
    const res = await fetch(`/api/events/${eventId}`, {
      method: 'PUT',
      headers: {
        'Content-Type':'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(event)
    });

    const data = await res.json();

    if (res.ok) {
      messageDiv.className = 'success';
      messageDiv.innerHTML = '<i class="fas fa-check-circle"></i> Evento aggiornato con successo! Reindirizzamento...';
      setTimeout(() => window.location.href = '/user.html', 1500);
    } else {
      messageDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message || 'Ops! Non siamo riusciti ad aggiornare l\'evento'}`;
      updateBtn.disabled = false;
      updateBtn.innerHTML = '<i class="fas fa-save"></i> Salva Modifiche';
    }
  } catch(err) {
    console.error(err);
    messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Qualcosa è andato storto. Riprova tra poco!';
    updateBtn.disabled = false;
    updateBtn.innerHTML = '<i class="fas fa-save"></i> Salva Modifiche';
  }
});

document.getElementById('backBtn').addEventListener('click', () => {
  window.location.href = '/user.html';
});
</script>

</body>
</html>