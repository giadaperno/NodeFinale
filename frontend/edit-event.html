<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EventHub - Modifica Evento</title>
<link rel="stylesheet" href="/css/edit-event.css">
</head>
<body>

<header>
  <h1>EventHub - Modifica Evento</h1>
  <button id="backBtn" class="secondary">Indietro</button>
</header>

<div class="edit-container">
  <h2>Modifica Evento</h2>
  
  <input type="text" id="title" placeholder="Titolo evento">
  <textarea id="description" placeholder="Descrizione evento"></textarea>
  <input type="text" id="category" placeholder="Categoria">
  <input type="text" id="location" placeholder="Luogo">
  <input type="date" id="date">
  <input type="number" id="capacity" placeholder="Capacità">
  <input type="url" id="image" placeholder="URL immagine (opzionale)" maxlength="500" style="width: 100%;">
  
  <button id="updateBtn" class="primary">Salva Modifiche</button>

  <div id="message" style="color:red; margin-top:10px;"></div>
</div>

<script>
const token = localStorage.getItem('token');
if (!token) window.location.href = '/login.html';

const urlParams = new URLSearchParams(window.location.search);
const eventId = urlParams.get('id');

if (!eventId) {
  alert('Evento non trovato');
  window.location.href = '/user.html';
}

// Carica dati evento
async function loadEvent() {
  try {
    const res = await fetch(`/api/events/${eventId}`);
    const data = await res.json();
    if (!res.ok) {
      alert(data.message || 'Ops! Non riusciamo a trovare questo evento');
      window.location.href = '/user.html';
    } else {
      document.getElementById('title').value = data.title;
      document.getElementById('description').value = data.description;
      document.getElementById('category').value = data.category;
      document.getElementById('location').value = data.location;
      document.getElementById('date').value = data.date.split('T')[0];
      document.getElementById('capacity').value = data.capacity;
      document.getElementById('image').value = data.image || '';
    }
  } catch(err) {
    console.error(err);
    alert('Ops! Qualcosa è andato storto nel caricamento dell\'evento');
    window.location.href = '/user.html';
  }
}

loadEvent();

// Aggiorna evento
document.getElementById('updateBtn').addEventListener('click', async () => {
  const event = {
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    category: document.getElementById('category').value,
    location: document.getElementById('location').value,
    date: document.getElementById('date').value,
    capacity: document.getElementById('capacity').value,
    image: document.getElementById('image').value
  };

  try {
    const res = await fetch(`/api/events/${eventId}`, {
      method: 'PUT',
      headers: {
        'Content-Type':'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(event)
    });

    const data = await res.json();
    const messageDiv = document.getElementById('message');

    if (res.ok) {
      messageDiv.style.color = 'green';
      messageDiv.textContent = '✅ Evento aggiornato con successo!';
      setTimeout(() => window.location.href = '/user.html', 1500);
    } else {
      messageDiv.style.color = 'red';
      messageDiv.textContent = data.message || '⚠️ Ops! Non siamo riusciti ad aggiornare l\'evento';
    }
  } catch(err) {
    console.error(err);
    const messageDiv = document.getElementById('message');
    messageDiv.style.color = 'red';
    messageDiv.textContent = '⚠️ Qualcosa è andato storto. Riprova tra poco!';
  }
});

document.getElementById('backBtn').addEventListener('click', () => {
  window.location.href = '/user.html';
});
</script>

</body>
</html>