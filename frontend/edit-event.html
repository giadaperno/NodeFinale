<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EventHub - Modifica Evento</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="/css/edit-event.css">
</head>
<body>

<header>
  <h1>EventHub</h1>
  <button id="backBtn" class="secondary"><i class="fas fa-arrow-left"></i> Indietro</button>
</header>

<div class="edit-container">
  <div class="form-header">
    <i class="fas fa-edit"></i>
    <h2>Modifica Evento</h2>
  </div>
  
  <form id="editForm">
    <div class="form-group">
      <label for="title"><i class="fas fa-heading"></i> Titolo</label>
      <input type="text" id="title" placeholder="Titolo evento" required>
    </div>

    <div class="form-group">
      <label for="description"><i class="fas fa-align-left"></i> Descrizione</label>
      <textarea id="description" placeholder="Descrizione evento" rows="5" required></textarea>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="category"><i class="fas fa-tag"></i> Categoria</label>
        <select id="category" required>
          <option value="">Seleziona una categoria</option>
          <option value="Musica">Musica</option>
          <option value="Sport">Sport</option>
          <option value="Fiera">Fiera</option>
          <option value="Concerto">Concerto</option>
          <option value="Cucina">Cucina</option>
          <option value="Benessere">Benessere</option>
        </select>
      </div>

      <div class="form-group">
        <label for="location"><i class="fas fa-map-marker-alt"></i> Luogo</label>
        <input type="text" id="location" placeholder="Dove si svolge" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="date"><i class="fas fa-calendar"></i> Data</label>
        <input type="date" id="date" required>
      </div>

      <div class="form-group">
        <label for="capacity"><i class="fas fa-users"></i> Capacità</label>
        <input type="number" id="capacity" placeholder="Numero massimo partecipanti" min="1" required>
      </div>
    </div>

    <div class="form-group">
      <label for="image"><i class="fas fa-image"></i> URL Immagine (opzionale)</label>
      <input type="url" id="image" placeholder="https://esempio.com/immagine.jpg" maxlength="500">
    </div>
    
    <button type="submit" id="updateBtn" class="primary">
      <i class="fas fa-save"></i> Salva Modifiche
    </button>

    <div id="message"></div>
  </form>
</div>

<script>
const token = localStorage.getItem('token');
if (!token) window.location.href = '/login.html';

const urlParams = new URLSearchParams(window.location.search);
const eventId = urlParams.get('id');

if (!eventId) {
  alert('Evento non trovato');
  window.location.href = '/user.html';
}

// Carica dati evento
async function loadEvent() {
  try {
    const res = await fetch(`/api/events/${eventId}`);
    const data = await res.json();
    if (!res.ok) {
      alert(data.message || 'Ops! Non riusciamo a trovare questo evento');
      window.location.href = '/user.html';
    } else {
      document.getElementById('title').value = data.title;
      document.getElementById('description').value = data.description;
      document.getElementById('category').value = data.category;
      document.getElementById('location').value = data.location;
      document.getElementById('date').value = data.date.split('T')[0];
      document.getElementById('capacity').value = data.capacity;
      document.getElementById('image').value = data.image || '';
    }
  } catch(err) {
    console.error(err);
    alert('Ops! Qualcosa è andato storto nel caricamento dell\'evento');
    window.location.href = '/user.html';
  }
}

loadEvent();

// Aggiorna evento
document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const event = {
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    category: document.getElementById('category').value,
    location: document.getElementById('location').value,
    date: document.getElementById('date').value,
    capacity: document.getElementById('capacity').value,
    image: document.getElementById('image').value
  };

  const messageDiv = document.getElementById('message');
  const updateBtn = document.getElementById('updateBtn');
  
  // Disabilita il pulsante durante l'invio
  updateBtn.disabled = true;
  updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';

  try {
    const res = await fetch(`/api/events/${eventId}`, {
      method: 'PUT',
      headers: {
        'Content-Type':'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(event)
    });

    const data = await res.json();

    if (res.ok) {
      messageDiv.className = 'success-message';
      messageDiv.innerHTML = '<i class="fas fa-check-circle"></i> Evento aggiornato con successo!';
      setTimeout(() => window.location.href = '/user.html', 1500);
    } else {
      messageDiv.className = 'error-message';
      messageDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message || 'Ops! Non siamo riusciti ad aggiornare l\'evento'}`;
      updateBtn.disabled = false;
      updateBtn.innerHTML = '<i class="fas fa-save"></i> Salva Modifiche';
    }
  } catch(err) {
    console.error(err);
    messageDiv.className = 'error-message';
    messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Qualcosa è andato storto. Riprova tra poco!';
    updateBtn.disabled = false;
    updateBtn.innerHTML = '<i class="fas fa-save"></i> Salva Modifiche';
  }
});

document.getElementById('backBtn').addEventListener('click', () => {
  window.location.href = '/user.html';
});
</script>

</body>
</html>